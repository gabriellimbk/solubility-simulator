<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<!-- Mobile: allow pinch-zoom; open fully zoomed out (fit-to-width) -->
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover, shrink-to-fit=no" />
<title>Solubility Simulator: CaSO₄ ⇌ Ca²⁺ + SO₄²⁻</title>
<style>
  :root{
    --bg:#ffffff; --panel:#f8f9fa; --ink:#000000; --muted:#6c757d;
    --blue:#0066cc; --green:#00aa44; --red:#dc3545; --cyan:#0088aa; --border:#333333;
    --design-width:1100px; /* desktop canvas width to preserve on mobile */
  }
  html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background:var(--bg); color:var(--ink); min-height:100dvh;
  }

  /* SCALE-TO-FIT WRAPPER (keeps desktop layout on mobile) */
  #scaleContainer{ width:100%; touch-action:pan-y; }
  #scaler{ width:var(--design-width); transform-origin:top left; }
  @media (min-width:1100px){
    /* Desktop: no scaling */
    #scaler{ transform:none; width:100%; transform-origin:top center; }
  }

  header{
    padding:24px 20px 8px; text-align:center;
    background:linear-gradient(to bottom, #e8f4f8, #ffffff);
    border-bottom:4px solid var(--border);
  }
  header h1{margin:0; font-weight:800}
  header p{margin:.35rem 0 0; font-size:1.1rem}
  header p.chem-eqn .ksp{border:none; background:transparent; padding:0; margin-left:.35rem}

  .wrap{
    max-width:var(--design-width); margin:14px auto 40px; padding:0 16px 24px;
    display:grid; grid-template-columns:420px 1fr; gap:18px; /* always two columns */
  }
  .card{background:var(--panel); border:4px solid var(--border); border-radius:18px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,.1)}
  .row{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
  .slider-block{margin-top:4px}
  .pill{display:inline-flex; gap:.45rem; align-items:center; border-radius:999px; padding:.3rem .6rem; font-variant-numeric:tabular-nums; background:#e6f2ff; border:2px solid var(--blue); color:var(--blue); font-weight:600}
  input[type=range]{width:100%; accent-color:var(--blue)}

  /* Beaker */
  .beaker{
    --w:210px; width:var(--w); height:205px; border:4px solid var(--blue);
    border-bottom-left-radius:12px; border-bottom-right-radius:12px;
    position:relative; margin:8px auto 10px; background:linear-gradient(to bottom,#e6f7ff,#cceeff);
    padding:12px 8px 64px; overflow:hidden;
  }
  .b-labels{font-weight:600; line-height:1.25; text-align:center; font-size:.86rem;}
  .precip{
    position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
    background:#fff; border:2px solid var(--red);
    border-radius:14px 14px 8px 8px/18px 18px 10px 10px;
    box-shadow:0 0 8px rgba(220,53,69,.25), 0 2px 0 rgba(0,0,0,.06) inset;
    display:none; width:10px; height:6px; transition:all .25s ease-in-out;
  }
  .precip.show{display:block}

  /* Tracker (bright styles) */
  .tracker{margin-top:8px; padding:12px; background:#fff; border:2px solid var(--border); border-radius:8px}
  .grid{display:grid; grid-template-columns:1fr max-content; row-gap:6px; column-gap:10px; align-items:center; font-variant-numeric:tabular-nums slashed-zero}
  .val{padding:.2rem .45rem; border-radius:8px; background:#fff; border:2px solid var(--muted); text-align:right; min-width:8.8ch; font-weight:600}
  .ok-val{background:#ccffdb; border:2px solid #00c853; color:#00a944; font-weight:700}
  .ip-alert{background:#ffe0e6; border:2px solid #ff1744; color:#ff1744; font-weight:800}
  .sat{justify-self:start; font-weight:700; padding:.2rem .55rem; border-radius:10px}
  .ok{background:#ccffdb; border:2px solid #00c853; color:#00a944}
  .bad{background:#ffe0e6; border:2px solid #ff1744; color:#ff1744}

  /* Chart */
  .chart{display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; align-items:end}
  .bars-wrap{position:relative; padding:12px; background:#fff; border:2px solid var(--border); border-radius:8px}
  .ksp-line{ display:flex; justify-content:center; align-items:center; font-weight:800; letter-spacing:.2px; margin-bottom:6px; min-height:1.6em; text-align:center; color:var(--ink); }
  .ksp-line.red{ color: var(--red); }

  .bars{height:360px; display:grid; grid-template-columns:repeat(3,1fr); gap:20px; align-items:end}
  .bar{ width:60%; justify-self:center; border-radius:12px 12px 0 0; position:relative; box-shadow:0 2px 8px rgba(0,0,0,.15); border:2px solid; }
  .bar small{position:absolute; top:-22px; left:50%; transform:translateX(-50%); font-variant-numeric:tabular-nums; font-weight:600; white-space:nowrap}
  #barCa{background:rgba(0,102,204,0.2); border-color:var(--blue)}
  #barSO4{background:rgba(0,170,68,0.2); border-color:var(--green)}
  #barSolid{background:#e5e7eb; border-color:var(--muted)}
  .bar-title{text-align:center; margin-top:8px; color:var(--ink); font-weight:700; font-size:1.15rem; letter-spacing:.1px}

  .toggle{margin-top:8px; display:flex; align-items:center; gap:.6rem; font-weight:600}
  details summary{cursor:pointer; font-weight:600}

  /* >>> Conservation (added from working version) <<< */
  .conservation-wrap{margin-top:20px; padding:16px; background:#fff; border:3px solid var(--cyan); border-radius:12px}
  .conservation-grid{display:grid; grid-template-columns:1fr max-content 1fr max-content 1fr; column-gap:12px; row-gap:8px; align-items:center; justify-items:center}
  .conservation-grid .head{font-weight:600}
  .conservation-grid .op{font-weight:700; color:var(--cyan)}
  .cons-val{display:inline-block; padding:.3rem .6rem; border-radius:8px; font-variant-numeric:tabular-nums; font-weight:700; min-width:10ch; text-align:center}
  .cons-val-ca{background:rgba(0,102,204,0.2); border:3px solid var(--blue); color:var(--blue)}
  .cons-val-so4{background:rgba(0,170,68,0.2); border:3px solid var(--green); color:var(--green)}

  /* Table */
  table{width:100%; border-collapse:collapse; background:#fff; border:2px solid var(--border); border-radius:8px}
  thead{background:#f0f0f0}
  th,td{border-bottom:1px solid #e0e0e0; padding:6px 8px}
  tbody tr:hover{background:#f8f8f8}

  /* Mobile tweaks (keep two columns! do NOT override .wrap grid here) */
  @media (max-width: 768px){
    .bars{height:280px}
    .bar small{top:-18px; font-size:.9rem}
    .bar-title{font-size:1.05rem}
    .b-labels{font-size:.8rem}
    .tracker .grid{grid-template-columns:1fr max-content}
    .conservation-grid{grid-template-columns:1fr 24px 1fr 24px 1fr}
    .bars-wrap{padding:10px}
    .ksp-line{font-size:.95rem}
    .row.table-wrap{overflow:auto}
  }
</style>
</head>
<body>

<!-- SCALE WRAPPER -->
<div id="scaleContainer">
  <div id="scaler">
    <header>
      <h1>• Solubility Simulator •</h1>
      <p>What happens when solid Na₂SO₄ is gradually added to a solution of Ca²⁺ ?</p>
      <p class="chem-eqn">Ca²⁺(aq) + SO₄²⁻(aq) ⇌ CaSO₄(s) ; <span class="ksp">K<sub>sp</sub> = 5.0 × 10⁻⁵</span></p>
    </header>

    <div class="wrap">
      <!-- LEFT -->
      <section class="card">
        <h3 style="margin:6px 0 6px">Add Na₂SO₄(s)</h3>
        <div class="slider-block">
          <div class="pill"><b id="nAdded">0.000</b> mol</div>
          <input id="stepSlider" type="range" min="0" max="20" step="1" value="0" />
        </div>

        <div class="beaker">
          <div class="b-labels">
            vol = 1&nbsp;dm³<br/>
            initial n Ca²⁺ = 0.010 mol
          </div>
          <div id="precip" class="precip" title="CaSO₄(s)"></div>
        </div>

        <div class="tracker">
          <div class="grid">
            <div><b>n Ca²⁺(aq)</b></div><div class="val" id="nCa">0.01000</div>
            <div><b>n SO₄²⁻(aq)</b></div><div class="val" id="nSulf">0.00000</div>
            <div><b>ionic product: [Ca²⁺][SO₄²⁻]</b></div><div class="val" id="ip">0.00000</div>
            <div><b>status</b></div><div id="satBadge" class="sat ok">not saturated</div>
            <div><b>n CaSO₄(s)</b></div><div class="val" id="nSolid">0.00000</div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <label class="toggle"><input id="showBars" type="checkbox" checked /><span>Show bar graph</span></label>
        </div>

        <div id="barsWrap" class="bars-wrap">
          <div id="kspLine" class="ksp-line">[Ca²⁺][SO₄²⁻] < 5.0 × 10⁻⁵</div>

          <div class="chart">
            <div>
              <div class="bars">
                <div class="bar" id="barCa"><small id="barCaVal">0.01000 mol</small></div>
                <div class="bar" id="barSO4"><small id="barSO4Val">0.00000 mol</small></div>
                <div class="bar" id="barSolid"><small id="barSolidVal">0.00000 mol</small></div>
              </div>
              <div class="row" style="justify-content:space-around">
                <div class="bar-title" style="color:var(--blue)">n Ca²⁺(aq)</div>
                <div class="bar-title" style="color:var(--green)">n SO₄²⁻(aq)</div>
                <div class="bar-title" style="color:var(--muted)">n CaSO₄(s)</div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <label class="toggle">
            <input id="showConservation" type="checkbox" checked />
            <span>Show conservation of mass</span>
          </label>
        </div>

        <!-- Conservation of Mass (working structure) -->
        <div id="conservationWrap" class="conservation-wrap">
          <h4 style="margin:0 0 12px; color:var(--cyan)">Conservation of Mass</h4>

          <div class="conservation-grid" style="margin-bottom:12px">
            <div class="head">n Ca²⁺(aq)</div>
            <div class="op">+</div>
            <div class="head">n Ca²⁺ in ppt</div>
            <div class="op">=</div>
            <div class="head">n Ca²⁺ total</div>

            <span class="cons-val cons-val-ca" id="consCaAq">0.01000 mol</span>
            <div class="op">+</div>
            <span class="cons-val cons-val-ca" id="consCaS">0.00000 mol</span>
            <div class="op">=</div>
            <span class="cons-val cons-val-ca">0.01000 mol</span>
          </div>

          <div class="conservation-grid">
            <div class="head">n SO₄²⁻(aq)</div>
            <div class="op">+</div>
            <div class="head">n SO₄²⁻ in ppt</div>
            <div class="op">=</div>
            <div class="head">n SO₄²⁻ total</div>

            <span class="cons-val cons-val-so4" id="consSO4Aq">0.00000 mol</span>
            <div class="op">+</div>
            <span class="cons-val cons-val-so4" id="consSO4S">0.00000 mol</span>
            <div class="op">=</div>
            <span class="cons-val cons-val-so4" id="consSO4Total">0.00000 mol</span>
          </div>
        </div>

        <details style="margin-top:16px">
          <summary>Show reference table</summary>
          <div class="row table-wrap" style="margin-top:8px">
            <table>
              <thead>
                <tr>
                  <th>n SO₄²⁻ added</th>
                  <th>n Ca²⁺(aq)</th>
                  <th>n SO₄²⁻(aq)</th>
                  <th>n CaSO₄(s)</th>
                  <th>I.P.</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="refTable"></tbody>
            </table>
          </div>
        </details>
      </section>
    </div>
  </div>
</div>

<script>
/* Scale-to-fit (keeps two columns on mobile, default fully zoomed out) */
(function(){
  const DESIGN_WIDTH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--design-width')) || 1100;
  const scaleContainer = document.getElementById('scaleContainer');
  const scaler = document.getElementById('scaler');

  function applyPageScale(){
    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    if (vw >= DESIGN_WIDTH){
      scaler.style.transform = 'none';
      scaler.style.width = '100%';
      scaleContainer.style.height = 'auto';
      return;
    }
    const scale = Math.min(1, vw / DESIGN_WIDTH);
    scaler.style.width = DESIGN_WIDTH + 'px';
    scaler.style.transform = 'scale(' + scale + ')';
    const naturalHeight = scaler.scrollHeight;
    scaleContainer.style.height = (naturalHeight * scale) + 'px';
  }

  window.addEventListener('resize', applyPageScale, { passive:true });
  window.addEventListener('orientationchange', applyPageScale, { passive:true });
  document.addEventListener('DOMContentLoaded', applyPageScale);
  window.addEventListener('load', applyPageScale);

  // Recalc when toggles change content height
  function recalc(){ window.dispatchEvent(new Event('resize')); }
  document.addEventListener('change', e=>{
    if (e.target && (e.target.id === 'showBars' || e.target.id === 'showConservation')) recalc();
  });
})();

/* DATA */
const DATA = [
  { added: 0.000, nCa: 0.01000, nSO4: 0.00000, nSolid: 0.00000, ip: 0.00000, sat: false },
  { added: 0.001, nCa: 0.01000, nSO4: 0.00100, nSolid: 0.00000, ip: 0.00001, sat: false },
  { added: 0.002, nCa: 0.01000, nSO4: 0.00200, nSolid: 0.00000, ip: 0.00002, sat: false },
  { added: 0.003, nCa: 0.01000, nSO4: 0.00300, nSolid: 0.00000, ip: 0.00003, sat: false },
  { added: 0.004, nCa: 0.01000, nSO4: 0.00400, nSolid: 0.00000, ip: 0.00004, sat: false },
  { added: 0.005, nCa: 0.01000, nSO4: 0.00500, nSolid: 0.00000, ip: 0.00005, sat: true  },
  { added: 0.006, nCa: 0.00935, nSO4: 0.00535, nSolid: 0.00065, ip: 0.00005, sat: true  },
  { added: 0.007, nCa: 0.00873, nSO4: 0.00573, nSolid: 0.00127, ip: 0.00005, sat: true  },
  { added: 0.008, nCa: 0.00814, nSO4: 0.00614, nSolid: 0.00186, ip: 0.00005, sat: true  },
  { added: 0.009, nCa: 0.00759, nSO4: 0.00659, nSolid: 0.00241, ip: 0.00005, sat: true  },
  { added: 0.010, nCa: 0.00707, nSO4: 0.00707, nSolid: 0.00293, ip: 0.00005, sat: true  },
  { added: 0.011, nCa: 0.00659, nSO4: 0.00759, nSolid: 0.00341, ip: 0.00005, sat: true  },
  { added: 0.012, nCa: 0.00614, nSO4: 0.00814, nSolid: 0.00386, ip: 0.00005, sat: true  },
  { added: 0.013, nCa: 0.00573, nSO4: 0.00873, nSolid: 0.00427, ip: 0.00005, sat: true  },
  { added: 0.014, nCa: 0.00535, nSO4: 0.00935, nSolid: 0.00465, ip: 0.00005, sat: true  },
  { added: 0.015, nCa: 0.00500, nSO4: 0.01000, nSolid: 0.00500, ip: 0.00005, sat: true  },
  { added: 0.016, nCa: 0.00468, nSO4: 0.01068, nSolid: 0.00532, ip: 0.00005, sat: true  },
  { added: 0.017, nCa: 0.00439, nSO4: 0.01139, nSolid: 0.00561, ip: 0.00005, sat: true  },
  { added: 0.018, nCa: 0.00412, nSO4: 0.01212, nSolid: 0.00588, ip: 0.00005, sat: true  },
  { added: 0.019, nCa: 0.00388, nSO4: 0.01288, nSolid: 0.00612, ip: 0.00005, sat: true  },
  { added: 0.020, nCa: 0.00366, nSO4: 0.01366, nSolid: 0.00634, ip: 0.00005, sat: true  },
];

/* Elements */
const stepSlider = document.getElementById('stepSlider');
const nAdded = document.getElementById('nAdded');
const nCa = document.getElementById('nCa');
const nSulf = document.getElementById('nSulf');
const nSolid = document.getElementById('nSolid');
const ip = document.getElementById('ip');
const satBadge = document.getElementById('satBadge');
const precip = document.getElementById('precip');
const barCa = document.getElementById('barCa');
const barSO4 = document.getElementById('barSO4');
const barSolid = document.getElementById('barSolid');
const barCaVal = document.getElementById('barCaVal');
const barSO4Val = document.getElementById('barSO4Val');
const barSolidVal = document.getElementById('barSolidVal');
const showBars = document.getElementById('showBars');
const barsWrap = document.getElementById('barsWrap');
const kspLine = document.getElementById('kspLine');
const refTable = document.getElementById('refTable');

const showConservation = document.getElementById('showConservation');
const conservationWrap = document.getElementById('conservationWrap');
const consCaAq = document.getElementById('consCaAq');
const consCaS = document.getElementById('consCaS');
const consSO4Aq = document.getElementById('consSO4Aq');
const consSO4S = document.getElementById('consSO4S');
const consSO4Total = document.getElementById('consSO4Total');

/* Axis */
const GLOBAL_MAX = Math.max(...DATA.map(d => Math.max(d.nCa, d.nSO4, d.nSolid)));
const MAX_SOLID = Math.max(...DATA.map(d => d.nSolid));

/* Reference table */
function buildRefTable(){
  refTable.innerHTML = DATA.map(d => `
    <tr>
      <td>${d.added.toFixed(3)}</td>
      <td>${d.nCa.toFixed(5)}</td>
      <td>${d.nSO4.toFixed(5)}</td>
      <td>${d.nSolid.toFixed(5)}</td>
      <td>${d.ip.toFixed(5)}</td>
      <td>${d.sat ? "saturated" : "not saturated"}</td>
    </tr>
  `).join('');
}

/* Bars */
function setBars(v1,v2,v3){
  const scale = x => Math.max(4, (x/ GLOBAL_MAX)*100);
  barCa.style.height = scale(v1)+'%';
  barSO4.style.height = scale(v2)+'%';
  barSolid.style.height = scale(v3)+'%';
  barCaVal.textContent = v1.toFixed(5) + ' mol';
  barSO4Val.textContent = v2.toFixed(5) + ' mol';
  barSolidVal.textContent = v3.toFixed(5) + ' mol';
}

/* Update conservation values */
function updateConservation(d) {
  consCaAq.textContent = d.nCa.toFixed(5) + ' mol';
  consCaS.textContent = d.nSolid.toFixed(5) + ' mol';
  consSO4Aq.textContent = d.nSO4.toFixed(5) + ' mol';
  consSO4S.textContent = d.nSolid.toFixed(5) + ' mol';
  consSO4Total.textContent = d.added.toFixed(5) + ' mol';
}

/* Update Ksp statement */
function updateKspLine(added){
  const EPS = 1e-12;
  kspLine.classList.remove('red');
  if (added < 0.004 - EPS) {
    kspLine.textContent = '[Ca²⁺][SO₄²⁻] < 5.0 × 10⁻⁵';
  } else {
    kspLine.textContent = '[Ca²⁺][SO₄²⁻] = 5.0 × 10⁻⁵';
    kspLine.classList.add('red');
  }
}

/* Apply one row to UI */
function apply(idx){
  const d = DATA[idx];
  nAdded.textContent = d.added.toFixed(3);
  nCa.textContent = d.nCa.toFixed(5);
  nSulf.textContent = d.nSO4.toFixed(5);
  nSolid.textContent = d.nSolid.toFixed(5);
  ip.textContent = d.ip.toFixed(5);

  // IP box state (bright colors)
  if (d.ip <= 0.00004 + 1e-10) {
    ip.classList.add('ok-val');
    ip.classList.remove('ip-alert');
  } else if (d.ip >= 0.00005 - 1e-10) {
    ip.classList.add('ip-alert');
    ip.classList.remove('ok-val');
  } else {
    ip.classList.remove('ip-alert');
    ip.classList.remove('ok-val');
  }

  if(d.sat){ satBadge.textContent = 'saturated'; satBadge.className = 'sat bad'; }
  else      { satBadge.textContent = 'not saturated'; satBadge.className = 'sat ok'; }

  // Precipitate sizing with safety cap so it never collides with top labels
  if(d.added >= 0.006 - 1e-12){
    const frac = Math.max(0, Math.min(1, d.nSolid / MAX_SOLID));
    const beaker = document.querySelector('.beaker');
    const beakerH = beaker ? beaker.clientHeight : 205;
    const safeTopGap = 80; // px reserved for .b-labels
    const maxPptH = Math.max(30, beakerH - safeTopGap - 20); // headroom + bottom

    const w = 30 + frac * 110;
    const h = Math.min(10 + frac * 52, maxPptH);
    precip.style.width = w + 'px';
    precip.style.height = h + 'px';
    precip.classList.add('show');
  }else{
    precip.classList.remove('show');
  }

  setBars(d.nCa, d.nSO4, d.nSolid);
  updateConservation(d);
  updateKspLine(d.added);
}

/* Interactions */
stepSlider.addEventListener('input', e => apply(+e.target.value));
showBars.addEventListener('change', e => {
  barsWrap.style.display = e.target.checked ? 'block' : 'none';
  window.dispatchEvent(new Event('resize')); // keep scaled height correct
});
showConservation.addEventListener('change', e => {
  conservationWrap.style.display = e.target.checked ? 'block' : 'none';
  window.dispatchEvent(new Event('resize'));
});

/* Init */
buildRefTable();
apply(0);
</script>
</body>
</html>
